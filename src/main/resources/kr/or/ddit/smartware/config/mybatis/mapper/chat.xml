<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="chat">
	<select id="getChatList" parameterType="String" resultType="hashmap">
		select b.chat_id, b.chat_nm, a.msg_cont, b.cnt, a.send_dt
	 	  from message a, (select b.chat_id, b.chat_nm, count(*) as cnt
		                     from chat_emp a, (select a.*
		                                         from CHAT a, CHAT_EMP b
		                                        where a.chat_id = b.chat_id
		                                          and b.emp_id = #{chat_id}) b
		                    where a.chat_id = b.chat_id
		                    group by b.chat_id,b.chat_nm) b
		 where a.chat_id = b.chat_id
		   and a.send_dt in (select send_dt
		                       from (select a.chat_id, max(send_dt) as send_dt 
		                               from message a, (select a.*
		                                                  from CHAT a, CHAT_EMP b
		                                                 where a.chat_id = b.chat_id
		                                                   and b.emp_id = #{chat_id}) b
		                              where a.chat_id = b.chat_id
		                              group by a.chat_id))
	</select>
	
	<select id="getChatNm" parameterType="String" resultType="String">
		select chat_nm
		  from chat
		 where chat_id = #{chat_id}
	</select>
	
	<select id="getChatEmp" parameterType="map" resultType="employee">
		select b.*
		  from chat_emp a, employee b
		 where a.chat_id = #{chat_id}
		   and a.emp_id != #{emp_id}
		   and a.emp_id = b.emp_id
	</select>
	
	<select id="getMessageList" parameterType="String" resultType="hashmap">
		select a.*, b.emp_nm, b.emp_pic, b.rank
	  	  from message a, employee b
		 where a.chat_id = #{chat_id}
		   and a.emp_id = b.emp_id
	</select>
	
	<insert id="insertMessage" parameterType="message">
		INSERT INTO MESSAGE VALUES('msg' || LPAD(MESSAGE_SEQ.NEXTVAL,3,0), #{chat_id}, #{msg_cont}, #{emp_id}, SYSDATE)
	</insert>
	
</mapper>