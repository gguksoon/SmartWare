<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="appl">
    <select id="getAppl" parameterType="string" resultType="application">
        SELECT *
        FROM APPLICATION
        WHERE APPL_ID = #{appl_id}
    </select>
	<select id="getApprMem" parameterType="hashMap" resultType="apprMember">
        SELECT *
        FROM APPR_MEMBER
        WHERE APPR_LINE_OWNER = #{emp_id}
        AND APPR_LINE_ID = #{appr_line_id}
    </select>

    <insert id="insertAppl" parameterType="hashmap">
        <selectKey keyProperty="appl_id" resultType="String" order="AFTER">
            SELECT 'appl' || lpad(application_seq.currval, 4, 0) FROM  DUAL
        </selectKey>
        INSERT INTO APPLICATION
        VALUES ( 'appl' || lpad(application_seq.nextval, 4, 0), #{title}, #{cont}, SYSDATE, #{form_id}, #{emp_id} )
    </insert>

    <insert id="setAppr" parameterType="hashmap">
        INSERT INTO APPL_APPR (appl_id, appr_emp, ap_order, able)
        VALUES (
            #{appl_id},
            #{appr_emp},
            (SELECT ap_order
            FROM APPR_MEMBER
            WHERE APPR_EMP = #{appr_emp}
            AND APPR_LINE_ID = (SELECT APPR_LINE_ID
                                FROM FORM
                                WHERE FORM_ID = #{form_id})
            AND APPR_LINE_OWNER = #{emp_id}),
            'F'
        )
    </insert>

    <update id="confirmAppl" parameterType="applAppr">
        UPDATE APPL_APPR SET ABLE = #{able}
        WHERE appl_id = #{appl_id}
        AND appr_emp = #{appr_emp}
    </update>

    <select id="sendApplList" parameterType="String" resultType="hashMap">
        SELECT a.*, b.EMP_NM, c.FORM_NM
        FROM APPLICATION a
        LEFT OUTER JOIN EMPLOYEE b ON a.EMP_ID = b.EMP_ID
        LEFT OUTER JOIN FORM c ON a.FORM_ID = c.FORM_ID
        WHERE a.emp_id = #{emp_id}
        ORDER  BY a.APPL_ID
    </select>

    <select id="confirmStatus" parameterType="String" resultType="applAppr">
        SELECT *
        FROM APPL_APPR
        WHERE APPL_ID = #{appl_id}
        order by 2 desc
    </select>

    <select id="confirmApplList" parameterType="String" resultType="hashMap">
        SELECT a.*, b.able, c.EMP_NM, d.FORM_NM
        FROM APPLICATION a
        RIGHT OUTER JOIN (SELECT a.APPL_ID, a.able,
                    NVL((SELECT able FROM APPL_APPR WHERE APPL_ID IN b.APPL_ID AND AP_ORDER = a.AP_ORDER + 1), 'T') AS NEXT_ABLE
                FROM APPL_APPR a, APPLICATION b
                WHERE a.APPL_ID IN b.APPL_ID
                AND a.appr_emp = #{emp_id}
                ORDER BY a.APPL_ID) b
        ON a.APPL_ID = b.APPL_ID
        LEFT OUTER JOIN EMPLOYEE c ON a.EMP_ID = c.EMP_ID
        LEFT OUTER JOIN form d ON a.FORM_ID = d.FORM_ID
        WHERE b.NEXT_ABLE = 'T'
        ORDER BY b.able, a.APPL_ID
    </select>
</mapper>